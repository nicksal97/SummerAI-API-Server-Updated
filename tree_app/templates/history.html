<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Run History</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#0b1020; color:#dbe2ff; }
    header { padding: 16px 20px; background:#111834; border-bottom:1px solid #1c2446; }
    h1 { margin:0; font-size:20px; }
    main { padding: 20px; display: grid; grid-template-columns: 320px 1fr; gap: 18px; }
    .panel { background:#0f1630; border:1px solid #1c2446; border-radius:12px; padding:14px; }
    label { display:block; font-size:13px; margin-bottom:6px; color:#9fb0ff; }
    select, button, a.btn { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3566; background:#101a3c; color:#dbe2ff; }
    .thumb { width:100%; aspect-ratio: 4/3; object-fit: cover; border-radius: 10px; border:1px solid #283362; background:#0b122d; }
    .row { display:flex; gap:10px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap:10px; }
    .card { background:#0d1430; border:1px solid #273164; border-radius:10px; padding:8px; }
    .card img { width:100%; border-radius:8px; border:1px solid #2a3566; background:#09102a; }
    .meta { font-size:12px; color:#93a6ff; margin-top:6px; word-break: break-all;}
    #map { width:100%; height:320px; border-radius:12px; border:1px solid #273164; background:#09102a; }
    .section { margin-top: 14px; }
    .muted { color:#91a2ffb0; font-size:12px; }
  </style>
</head>
<body>
  <header><h1>Run History</h1></header>
  <main>
    <aside class="panel">
      <label for="runSelect">Select a run</label>
      <select id="runSelect"></select>

      <div class="section">
        <div id="labelBox" class="muted"></div>
        <img id="thumb" class="thumb" alt="thumbnail" />
      </div>

      <div class="section row">
        <a id="dlZip" class="btn" href="#" download>Download Inputs ZIP</a>
        <a id="dlGeo" class="btn" href="#" download>Download GeoJSON</a>
      </div>
      <div class="section">
        <a id="dlOutZip" class="btn" href="#" download>Download Results ZIP</a>
      </div>

      <div class="section">
        <button id="btnLatestGeo">Load Latest GeoJSON on Map</button>
      </div>
    </aside>

    <section class="panel">
      <div id="map"></div>

      <div class="section">
        <h2>Processed Images</h2>
        <div id="outGrid" class="grid"></div>
      </div>

      <div class="section">
        <h2>Original Images</h2>
        <div id="inGrid" class="grid"></div>
      </div>
    </section>
  </main>

  <script>
    const sel = document.getElementById('runSelect');
    const labelBox = document.getElementById('labelBox');
    const thumb = document.getElementById('thumb');
    const dlZip = document.getElementById('dlZip');
    const dlGeo = document.getElementById('dlGeo');
    const dlOutZip = document.getElementById('dlOutZip');
    const outGrid = document.getElementById('outGrid');
    const inGrid = document.getElementById('inGrid');
    const btnLatestGeo = document.getElementById('btnLatestGeo');

    let map, layer;
    const initialRun = new URLSearchParams(location.search).get('run');

    function initMap() {
      map = L.map('map', { zoomControl: true }).setView([51.0, 10.0], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(map);
    }
    function clearLayer() { if (layer) { layer.remove(); layer = null; } }
    function fitIfPossible(geojson) {
      try { const gj = L.geoJSON(geojson); const b = gj.getBounds(); if (b && b.isValid()) map.fitBounds(b.pad(0.2)); } catch {}
    }

    function renderRun(run) {
      document.title = (run.label || run.id) + ' — Run History';
      labelBox.textContent = run.label ? ('Label: ' + run.label) : ('Run ID: ' + run.id);
      thumb.src = run.thumbnail || (run.output_images?.[0] || "");
      dlZip.href = run.zip_path || "#";
      dlGeo.href = run.geojson_path || "#";
      dlOutZip.href = run.outputs_zip_path || "#";

      outGrid.innerHTML = "";
      (run.output_images || []).forEach(u => {
        outGrid.insertAdjacentHTML("beforeend", `<div class="card"><img src="${u}" /><div class="meta">${u}</div></div>`);
      });
      inGrid.innerHTML = "";
      (run.input_images || []).forEach(u => {
        inGrid.insertAdjacentHTML("beforeend", `<div class="card"><img src="${u}" /><div class="meta">${u}</div></div>`);
      });

      if (run.geojson_path) {
        fetch(run.geojson_path)
          .then(r => r.ok ? r.json() : Promise.reject())
          .then(gj => { clearLayer(); layer = L.geoJSON(gj).addTo(map); fitIfPossible(gj); })
          .catch(() => { clearLayer(); });
      } else {
        clearLayer();
      }
    }

    function loadRun(id) {
      fetch(`/api/runs/${id}`).then(r => r.json()).then(j => {
        if (j.status && j.run) renderRun(j.run);
      });
    }

    function loadRuns() {
      fetch('/api/runs').then(r => r.json()).then(j => {
        sel.innerHTML = "";
        if (!j.status) return;

        const runs = j.runs || [];
        if (!runs.length) {
          sel.insertAdjacentHTML("beforeend", `<option>No runs yet</option>`);
          return;
        }

        runs.forEach(run => {
          const label = run.label ? ` (${run.label})` : "";
          const created = run.created_at ? new Date(run.created_at).toLocaleString() : 'unknown';
          sel.insertAdjacentHTML("beforeend", `<option value="${run.id}">${run.id}${label} — ${created}</option>`);
        });

        const initial = (initialRun && runs.some(r => r.id === initialRun)) ? initialRun : runs[0].id;
        sel.value = initial;
        loadRun(initial);
      });
    }

    sel.addEventListener('change', () => { const id = sel.value; if (id) loadRun(id); });
    btnLatestGeo.addEventListener('click', () => {
      fetch('/api/geojson/latest').then(r => r.json()).then(j => {
        if (!j.status) return;
        clearLayer(); layer = L.geoJSON(j.geojson_data || {}).addTo(map); fitIfPossible(j.geojson_data || {});
      });
    });

    initMap();
    loadRuns();
  </script>
</body>
</html>
