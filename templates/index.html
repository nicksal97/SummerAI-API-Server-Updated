<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
  <title>TREE PROJECT</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <style>
    .overlay {
      display: none;
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: 999;
      background: rgba(255,255,255,0.8) url("{% static 'loader/loading.gif' %}") center no-repeat;
    }
    body {
      text-align: center;
    }
    body.loading {
      overflow: hidden;
    }
    body.loading .overlay {
      display: block;
    }
    .ScrollStyle {
      max-height: 335px;
      overflow-y: scroll;
    }
  </style>
</head>
<body>
<div class="overlay"></div>

<!-- Top navigation bar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand btn btn-primary text-white mr-2" href="{% url 'index' %}">Home</a>
  <a class="navbar-brand btn btn-success text-white mr-2" href="{% url 'model-upload' %}">Upload Model</a>
  <div class="ml-auto">
    <a href="{% url 'logout' %}" class="btn btn-outline-danger">Logout</a>
  </div>
</nav>

<div class="container">
  <form id="myForm">
    <h1 class="text-center">TREE PROJECT</h1><br><br>
    <div class="form-group">
      <label for="model">Select Model Type:</label>
      <select class="form-control" id="model" name="model">
        <option value="winter">Winter</option>
        <option value="summer">Summer</option>
      </select>
    </div>
    <div class="form-group">
      <label for="model_name">Select Model Name:</label>
      <select class="form-control" id="model_name" name="model_name">
        <!-- Options will be dynamically populated here -->
      </select>
    </div>
     <div class="form-group">
      <label for="file">Select Tif File:</label>
      <input type="file" class="form-control" id="tif_file" name="tif_file" accept=".tif">
    </div>
    <div class="form-group">
      <label for="file">Select Zip Folder:</label>
      <input type="file" class="form-control" id="file" name="file" accept=".zip">
    </div>
    <button type="button" class="btn btn-primary" onclick="myFunction()">Submit</button>
  </form>
  <br>
  <div class="container" id="main_container">
    <div class="row">
      <div class="col">
        <h3>Original Images</h3>
        <div id="original-images" class="ScrollStyle"></div>
        <a id="download-zip" href="" download="output.zip" class="btn btn-primary">Zip-File-Download</a>
      </div>
      <div class="col">
        <h3>Processed Images</h3>
        <div id="processed-images" class="ScrollStyle"></div>
        <a id="download-geojson" href="" download="output.geojson" class="btn btn-primary">GeoJSON-Download</a>
      </div>
    </div>
    <div id="model-name" class="text-center mt-3"></div>
  </div>
  <br>
</div>

<script>
  $(document).ready(function() {
    // Initially, both fields are visible
    $('#tif_file').show();
    $('#file').show();

    // Event listener for .tif file input
    $('#tif_file').change(function() {
      if ($(this).val()) {
        $('#file').hide(); // Hide the .zip input
      } else {
        $('#file').show(); // Show the .zip input if no .tif is selected
      }
    });

    // Event listener for .zip file input
    $('#file').change(function() {
      if ($(this).val()) {
        $('#tif_file').hide(); // Hide the .tif input
      } else {
        $('#tif_file').show(); // Show the .tif input if no .zip is selected
      }
    });
  });
</script>

<script>
  $(document).ready(function() {
    $("#main_container").hide();

    // Function to update the model_name dropdown
    function updateModelNameDropdown(modelPaths) {
      var $modelNameDropdown = $('#model_name');
      $modelNameDropdown.empty(); // Clear any existing options

      // Populate the dropdown with model paths
      modelPaths.forEach(function(path) {
        if (path !== ".DS_Store") { // Ignore any unwanted files
          $modelNameDropdown.append(new Option(path, path));
        }
      });
    }

    // Initial API call to populate model names based on the default selected model type
    function fetchModelNames(selectedModel) {
      fetch(`/model-upload1/?model=${selectedModel}`, {
        method: 'GET',
      })
      .then(response => response.json())
      .then(data => {
        console.log("API Response:", data);
        // Update model_name dropdown with data.model_path
        updateModelNameDropdown(data.model_path);
      })
      .catch(error => {
        console.error("Error calling the API:", error);
      });
    }

    // Fetch model names when the page loads with default model
    fetchModelNames($("#model").val());

    // Handle model type change event
    $("#model").change(function() {
      var selectedModel = $(this).val();
      fetchModelNames(selectedModel);
    });
  });

  function myFunction() {
    var image_path = $("#file").prop('files')[0];
    var tif_file = $("#tif_file").prop('files')[0];
    var selected_model = $("#model").val();
    var model_name = $("#model_name").val();
     if (!image_path && !tif_file) {
    alert("Please select either a .zip file or a .tif file.");
    return; // Stop execution
  } else {
      var form_data = new FormData();
      form_data.append("file", image_path);
      form_data.append("tif_file", tif_file);
      form_data.append("model", selected_model);
      form_data.append("model_name", model_name);
      $.ajax({
        url: "/",
        type: "POST",
        data: form_data,
        contentType: false,
        processData: false,
        beforeSend: function() {
          $("body").addClass("loading");
        },
        success: function() {
          console.log("File submitted successfully");
        },
        complete: function(result) {
          $("body").removeClass("loading");
          var responseData = result['responseJSON'];

          if (responseData && responseData.status) {
            var geojson_path = responseData.geojson_path;
            var input_image_list = responseData.input_image_list;
            var output_image_list = responseData.output_image_list;
            var zip_path = responseData.zip_path;

            $('#original-images').empty();
            $('#processed-images').empty();

            input_image_list.forEach(function(image_path) {
              var img = $('<img>').attr('src', image_path).addClass('img-fluid mb-2');
              $('#original-images').append(img);
            });

            output_image_list.forEach(function(image_path) {
              var img = $('<img>').attr('src', image_path).addClass('img-fluid mb-2');
              $('#processed-images').append(img);
            });
            $("#download-geojson").attr("href", geojson_path);
            $("#download-zip").attr("href", zip_path);
            $("#model-name").text("Model Used: " + selected_model);

            $("#main_container").show();
          } else {
            alert("Please upload a valid .zip file or a .tif file.");
          }
        }
      });
    }
  }
</script>
</body>
</html>
